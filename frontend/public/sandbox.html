<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>React Sandbox</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: sans-serif; background-color: transparent; }
        #root { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/javascript">
        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error: error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Uncaught error in user component:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    const errorMessage = this.state.error ? this.state.error.toString() : 'An unknown error occurred.';
                    return React.createElement('pre', { style: { color: 'red', whiteSpace: 'pre-wrap', padding: '10px', fontFamily: 'monospace' } }, `Render Error:\n${errorMessage}`);
                }
                return this.props.children;
            }
        }

        // --- Communication Layer ---
        const parentOrigin = '*'; // In production, set this to your app's origin for security

        const callbacks = {
            onWorkflowOutputChange: (key, value) => {
                window.parent.postMessage({
                    type: 'SET_WORKFLOW_OUTPUT',
                    payload: { key, value }
                }, parentOrigin);
            },
            triggerWorkflow: () => {
                window.parent.postMessage({ type: 'TRIGGER_WORKFLOW_EXECUTION' }, parentOrigin);
            }
        };

        // --- Core Sandbox Logic ---
        function injectCSS(cssCode) {
            let styleTag = document.getElementById('user-styles');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'user-styles';
                document.head.appendChild(styleTag);
            }
            styleTag.textContent = cssCode;
        }

        function transpileJSX(jsxCode) {
            try {
                const transpiled = Babel.transform(jsxCode, {
                    presets: ['react', 'env'],
                    filename: 'UserComponent.jsx'
                }).code;
                return transpiled;
            } catch (error) {
                console.error("Babel Transpilation Error:", error);
                // Return code for a component that displays the error
                return `const MyErrorComponent = () => React.createElement('pre', { style: { color: 'red', whiteSpace: 'pre-wrap', padding: '10px', fontFamily: 'monospace' } }, 'Babel Error:\\n${error.message.replace(/'/g, "\\'").replace(/\n/g, "\\n")}');\nexport default MyErrorComponent;`;
            }
        }

        function renderUserComponent(jsxCode, cssCode, props) {
            injectCSS(cssCode);
            const transpiledCode = transpileJSX(jsxCode);

            const exports = {};
            const module = { exports };
            
            // Create a dummy 'require' function to handle transpiled 'import React from "react";'
            const require = (moduleName) => {
                if (moduleName === 'react') {
                    return window.React; // 'React' is globally available from the script tag
                }
                // For now, we only support 'react'.
                throw new Error(`Cannot find module '${moduleName}'. Only 'react' is supported in this sandbox.`);
            };
            
            try {
                new Function('React', 'module', 'exports', 'require', transpiledCode)(React, module, exports, require);
            } catch (error) {
                 console.error("Runtime Error in User Code:", error);
                 const ErrorComponent = () => React.createElement('pre', { style: { color: 'red', whiteSpace: 'pre-wrap', padding: '10px', fontFamily: 'monospace' } }, `Runtime Error:\n${error.message}`);
                 ReactDOM.render(React.createElement(ErrorComponent), document.getElementById('root'));
                 return;
            }

            const UserComponent = module.exports.default || module.exports;

            if (typeof UserComponent !== 'function' && typeof UserComponent !== 'object') {
                 const ErrorComponent = () => React.createElement('pre', { style: { color: 'red', padding: '10px', fontFamily: 'monospace' } }, 'Error: Component did not export a default React component.');
                 ReactDOM.render(React.createElement(ErrorComponent), document.getElementById('root'));
                 return;
            }

            const allProps = { ...props, ...callbacks };

            // Wrap the user component in our error boundary
            const app = React.createElement(ErrorBoundary, null, React.createElement(UserComponent, allProps));
            ReactDOM.render(app, document.getElementById('root'));
        }

        // --- Event Listener ---
        window.addEventListener('message', (event) => {
            const { type, payload } = event.data;
            if (type === 'RENDER_COMPONENT') {
                renderUserComponent(payload.jsx, payload.css, payload.props);
            }
        });

        // Signal to parent that the sandbox is ready
        window.parent.postMessage({ type: 'SANDBOX_READY' }, parentOrigin);
    </script>
</body>
</html>